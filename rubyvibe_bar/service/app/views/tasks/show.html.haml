- author = @task.user

.task-layout
  .tavern-card
    .card-header
      %div
        %h1.page-title= @task.title
        .card-meta
          - if author
            = avatar_tag_for(author, size: :small, html_options: { title: author.nickname, "aria-label": author.nickname, data: { label: author.nickname } })
          - else
            %span Удалённый автор
      - reward_label = @task.public_reward? ? "Награда открыта" : "Награда скрыта"
      %span.reward-status{ class: @task.public_reward? ? "reward-status--open" : "reward-status--locked", role: "img", "aria-label": reward_label, data: { label: reward_label } }

    .card-section
      %h3 Описание
      = simple_format(@task.description)

    - if @task.labyrinth_task_type? && @task.labyrinth_payload
      .card-section
        %h3 Лабиринт
        - laby = @task.labyrinth_payload
        .labyrinth-wrapper
          .labyrinth-grid{ style: "grid-template-columns: repeat(#{laby[:width]}, 18px);" }
            - laby[:grid].each_with_index do |row, r|
              - row.chars.each_with_index do |cell, c|
                - classes = ["labyrinth-cell"]
                - classes << "labyrinth-cell--wall" if cell == "1"
                - classes << "labyrinth-cell--start" if [r, c] == laby[:start]
                - classes << "labyrinth-cell--finish" if [r, c] == laby[:finish]
                %span{ class: classes.join(" ") }
          .labyrinth-info
            %p
              Старт: левый верхний угол. Финиш: правый нижний угол. Используйте последовательность ходов U, D, L, R.
            = form_with url: solve_task_path(@task), method: :post, data: { turbo_stream: true, turbo: true, controller: "labyrinth-form" }, local: false, class: "labyrinth-actions" do |f|
              .form__field
                = f.label :moves, "Последовательность ходов", class: "form__label"
                = f.text_field :moves, class: "form__input", placeholder: "Например: DDRRULLD"
              = f.submit "Проверить маршрут", class: "btn btn--secondary btn--slim btn--wide", style: "margin-top:10px;"
            - if @labyrinth_result
              - if @labyrinth_result[:success]
                %p.labyrinth-success Маршрут верный, награда открыта!
              - else
                %p.labyrinth-fail Маршрут неверный или упёрся в стену. Попробуйте ещё.

    = turbo_frame_tag "reward_panel" do
      = render partial: "tasks/reward_panel", locals: { task: @task, can_view_reward: @can_view_reward }

    - if user_signed_in? && current_user == @task.user
      .card-section
        = link_to "Редактировать", edit_task_path(@task), class: "btn btn--secondary"
        = link_to "Удалить", task_path(@task), data: { turbo_method: :delete, turbo_confirm: "Удалить задание?" }, class: "btn btn--danger"

  .tavern-card
    %h3 Трактирные разговоры
    .comments
      - @comments.each do |comment|
        = render partial: "tasks/comment", locals: { comment: comment, task: @task }
    - if user_signed_in?
      .comments-form
        %h4.comment-title Оставить запись в журнале таверны
        = form_with model: [@task, Comment.new], local: true do |f|
          .form__field
            = f.label :body, "Текст сообщения", class: "form__label"
            = f.text_area :body, rows: 4, class: "form__textarea"
          = f.submit "Отправить", class: "btn btn--secondary"
    - else
      %p.comments-note
        Чтобы присоединиться к разговору,
        = link_to "войдите", new_user_session_path
        или
        = link_to "зарегистрируйтесь", new_user_registration_path
